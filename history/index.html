<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alerts - Water Level Monitoring System</title>
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="custom.css">
    <style>
        .table-container {
        max-height: 400px;
        overflow-y: auto;
        }
        .status-critical {
            color: red;
            font-weight: bold;
        }
        .status-high {
            color: orange;
            font-weight: bold;
        }
        .status-moderate {
            color: gold;
            font-weight: bold;
        }
        .color-legend {
            display: flex;
            align-items: center;
            margin-left: auto; /* Push the legend to the right */
        }
        .color-legend-item {
            display: flex;
            align-items: center;
            margin-left: 15px; /* Add some space between items */
        }
        .color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        .color-box.critical {
            background-color: red;
        }
        .color-box.high {
            background-color: orange;
        }
        .color-box.moderate {
            background-color: gold;
        }
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space between title and legend */
        }
        /* Custom CSS for navigation bar */
        .navbar-nav {
            width: 100%;
            display: flex;
            align-items: center;
        }
        .navbar-nav .nav-item.flex-grow-1 {
            flex-grow: 1; /* Ensures the History text takes up remaining space */
        }
        .navbar-nav .nav-item:last-child {
            margin-left: auto; /* Pushes the Print button to the right */
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Sidebar toggle button -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                    <i class="fas fa-bars"></i>
                </a>
            </li>
            <!-- History Text -->
            <li class="nav-item flex-grow-1">
                <span class="nav-text">History</span>
            </li>
            <!-- Print Button -->
            <li class="nav-item">
                <button class="btn btn-primary" onclick="printTable()">
                    <i class="fas fa-print"></i> Print
                </button>
            </li>
        </ul>
    </nav>

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-light-primary elevation-2">
        <a class="brand-link">
            <img src="image/water-level-3-48.png" alt="Water Monitoring Logo" class="brand-image img-circle elevation-2" style="opacity: .8">
            <span class="brand-text font-weight-bold">Water Monitoring</span>
        </a>

        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/realtime" class="nav-link">
                            <i class="nav-icon fas fa-water"></i>
                            <p>Real-time Monitoring</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/alerts" class="nav-link">
                            <i class="nav-icon fas fa-bell"></i>
                            <p>Alerts</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/history" class="nav-link active">
                            <i class="nav-icon fas fa-history"></i>
                            <p>History</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">

        <!-- Main Content -->
        <section class="content mt-3">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <!-- Alerts Table -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Water Level History</h3>
                                <!-- Month Filter Dropdown -->
                                <div class="form-group" style="margin-bottom: 0;">
                                    <select id="monthFilter" class="form-control">
                                        <option value="all">All Months</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <!-- Color Code Section -->
                                <div class="color-legend">
                                    <div class="color-legend-item">
                                        <div class="color-box critical"></div>
                                        <span>Critical (Evacuate immediately)</span>
                                    </div>
                                    <div class="color-legend-item">
                                        <div class="color-box high"></div>
                                        <span>High (Prepare for possible evacuation)</span>
                                    </div>
                                    <div class="color-legend-item">
                                        <div class="color-box moderate"></div>
                                        <span>Moderate (Monitor closely)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date & Time</th>
                                                <th>Level</th>
                                                <th>Status</th>
                                                <th>Action Required</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Data will be fetched and displayed here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <strong>Water Monitoring System</strong>
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 1.0
        </div>
    </footer>
</div>

<!-- AdminLTE JS -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<!-- jQuery (required by AdminLTE) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Function to print the table
    function printTable() {
        // Clone the table to avoid modifying the original
        const table = document.querySelector(".table").cloneNode(true);

        // Remove the color legend from the cloned table
        const colorLegend = table.querySelector(".color-legend");
        if (colorLegend) {
            colorLegend.remove();
        }

        // Create a new window for printing
        const printWindow = window.open("", "_blank");
        printWindow.document.write(`
            <html>
                <head>
                    <title>Water Level History</title>
                    <style>
                        /* General styles */
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        h2 { text-align: center; margin-bottom: 20px; } /* Center the title */
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-critical { color: red; font-weight: bold; }
                        .status-high { color: orange; font-weight: bold; }
                        .status-moderate { color: gold; font-weight: bold; }

                        /* Print-specific styles */
                        @media print {
                            @page {
                                margin: 2cm; /* Add margin to all sides of the page */
                                size: auto; /* Ensure the page size is auto */
                            }
                            body { margin: 0; padding: 0; } /* Reset body margin and padding */
                            h2 { text-align: center; margin-bottom: 20px; } /* Center the title */
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; } /* Ensure table fits within margins */
                        }
                    </style>
                </head>
                <body>
                    <h2>Water Level History</h2>
                    ${table.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();

        // Wait for the content to load before printing
        printWindow.onload = function () {
            printWindow.print();
        };
    }

    document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.querySelector('[data-widget="pushmenu"]');
        toggleButton.addEventListener("click", () => {
            document.body.classList.toggle("sidebar-collapse");
        });

        // Fetch initial data
        fetchAlerts();

        // Add event listener for month filter
        const monthFilter = document.getElementById("monthFilter");
        monthFilter.addEventListener("change", (event) => {
            const selectedMonth = event.target.value;
            fetchAlerts(selectedMonth);
        });
    });
    async function fetchAlerts(month = "all") {
        const { data, error } = await supabase.from("water_levels").select("water_level, last_updated").order("last_updated", { ascending: false });
        if (error) return console.error("Error fetching data:", error);
        const tableBody = document.querySelector("table tbody");
        tableBody.innerHTML = "";
        data.forEach(alert => {
            const alertDate = new Date(alert.last_updated);
            const alertMonth = String(alertDate.getMonth() + 1).padStart(2, "0"); // Get month in "MM" format

            // Filter by month
            if (month === "all" || alertMonth === month) {
                let status = "Normal", actionRequired = "Monitor";
                if (alert.water_level >= 15) {
                    status = "Critical";
                    actionRequired = "Evacuate immediately";
                } else if (alert.water_level >= 6) {
                    status = "High";
                    actionRequired = "Prepare for possible evacuation";
                } else {
                    status = "Moderate";
                    actionRequired = "Monitor closely";
                }

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${alertDate.toLocaleString()}</td>
                    <td>${alert.water_level} cm</td>
                    <td class="status-${status.toLowerCase()}">${status}</td>
                    <td>${actionRequired}</td>
                `;
                tableBody.appendChild(row);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', fetchAlerts);

</script>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://efirubankmowqztlyuuh.supabase.co'; // Replace with your Supabase URL
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmaXJ1YmFua21vd3F6dGx5dXVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzMDc5NjAsImV4cCI6MjA1Mzg4Mzk2MH0.JmTTNz5AESMKQIwQl9t0qfU33EMLc5Z2-WePRGtaCog';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let lastWaterLevel = null;
      let notificationShown = false;
      function showNotification(title, message) {
        if (Notification.permission === "granted") {
          new Notification(title, { body: message, icon: "image/water-level-3-48.png" });
        }
      }
      const channel = supabase.channel("water-level-updates").on("postgres_changes", { event: "INSERT", schema: "public", table: "water_levels" }, (payload) => {
        const latestWaterLevel = payload.new.water_level;
       // **Early Warning System**
       if (lastWaterLevel !== null && latestWaterLevel > lastWaterLevel) {
                // Early Warning: Trigger only if the water level is rising and below 15
                if (latestWaterLevel < 15) {
                    showNotification(
                        "Early Warning: Water Level Rising",
                        `Warning: Water level is rising. Current level: ${latestWaterLevel.toFixed(1)}cm, Previous level: ${lastWaterLevel.toFixed(1)}cm`
                    );
                }
            }

            // **Warning Alert System**
            if (latestWaterLevel >= 15) {
                if (localStorage.getItem("warningNotificationShown") !== "true") {
                    showNotification(
                        "Water Level Alert",
                        `Warning: Water level is critically high at ${latestWaterLevel.toFixed(1)}cm!`
                    );
                    localStorage.setItem("warningNotificationShown", "true"); // Set the flag in localStorage
                }
            } else {
                // Reset the flag if the water level drops below 15
                localStorage.setItem("warningNotificationShown", "false");
            }
            // Update the last water level
            lastWaterLevel = latestWaterLevel;
      }).subscribe();

      setInterval(fetchAlerts, 1000);
</script>

<!-- Register the service worker -->
<script>
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
                console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((error) => {
                console.error('Service Worker registration failed:', error);
            });
    }
</script>

</body>
</html>